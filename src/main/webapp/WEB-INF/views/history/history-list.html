<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="right_col" role="main">
        <div class="">
            <div class="clearfix"></div>
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>History</h2>
                        <div class="clearfix"></div>
                    </div>

                    <div class="x_content">
                        <div class="container" style="padding: 50px;">
                            <form id="searchForm" th:object="${searchForm}" th:action="@{/history/1}" method="POST" class="form-horizontal form-label-left">
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" th:for="code">Code </label>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <input th:field="*{productInfo.code}" class="form-control col-md-7 col-xs-12" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" th:for="name">Category</label>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <input th:field="*{productInfo.category.name}" class="form-control col-md-7 col-xs-12" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" th:for="productInfo.name">Product</label>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <input th:field="*{productInfo.name}" class="form-control col-md-7 col-xs-12" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" th:for="actionName">Action </label>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <select th:field="*{actionName}" class="form-control">
                                            <option value="">------Select action------</option>
                                            <th:block th:each="action : ${mapAction}">
                                                <option th:value="${action.key}" th:text="${action.value}"></option>
                                            </th:block>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" th:for="type">Type </label>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <select th:field="*{type}" class="form-control">
                                            <th:block th:each="type : ${mapType}">
                                                <option th:value="${type.key}" th:text="${type.value}"></option>
                                            </th:block>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                                        <button type="submit" class="btn btn-success">Search</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped jambo_table bulk_action">
                                <thead>
                                <tr class="headings">
                                    <th class="column-title"># </th>
                                    <th class="column-title">Category</th>
                                    <th class="column-title">Code</th>
                                    <th class="column-title">Name</th>
                                    <th class="column-title">Qty </th>
                                    <th class="column-title">Price </th>
                                    <th class="column-title">Type</th>
                                    <th class="column-title">Action</th>
                                </tr>
                                </thead>

                                <tbody>
                                    <tr th:each="history, loop : ${histories}" th:class="${loop.index%2==0 } ? 'even pointer' : 'odd pointer'">
                                        <td class=" " th:text="${loop.index + 1 + pageInfo.offset}"></td>
                                        <td class=" " th:text="${history.productInfo.category.name }"></td>
                                        <td class=" " th:text="${history.productInfo.code }"></td>
                                        <td class=" " th:text="${history.productInfo.name }"></td>
                                        <td class=" " th:text="${history.qty }"></td>
                                        <td class="price-invoice " th:text="${history.price }"></td>
                                        <td class=" " th:text="${history.type == 1 ? 'Goods Receipt' : 'Goods Issues' }"></td>
                                        <td class=" " th:text="${history.actionName }"></td>

                                    </tr>
                                </tbody>
                            </table>

                            <th:block th:if="${pageInfo.totalPages > 0}">
                                <div style="display: flex;justify-content: center;align-items: center;">
                                    <span th:if="${pageInfo.totalPages > 1}" class="fa fa-angle-left" style="font-size: 24px;padding: 4px 18px;cursor: pointer;"
                                          th:onclick="|gotoPage(${pageInfo.indexPage} - 1);|"
                                    ></span>
                                    <ul class="pagination"></ul>
                                    <span th:if="${pageInfo.totalPages > 1}" class="fa fa-angle-right" style="font-size: 24px;padding: 4px 18px;cursor: pointer;"
                                          th:onclick="|gotoPage(${pageInfo.indexPage} + 1);|"
                                    ></span>
                                </div>
                            </th:block>
                            <th:block th:unless="${pageInfo.totalPages > 0}">
                                <p style="text-align: center;">History empty</p>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <script th:inline="javascript">
        var totalPages = [[${pageInfo.totalPages}]];
        var currentPage = [[${pageInfo.indexPage}]];

        function gotoPage(page){
            var baseUrl = [[@{/history/}]];
		    $('#searchForm').attr('action', baseUrl + page);
		    $('#searchForm').submit();
	    }

        $(document).ready(function(){
		    processMessage();
		    renderPagination(currentPage, totalPages);

            $('#product-infolistId').addClass('current-page').siblings()
                    .removeClass('current-page');
            $('#product-infolistId').addClass('active').siblings().removeClass('active');
            $('.price-invoice').each(function(){
                $(this).text(numeral($(this).text()).format('0,0'));
            })

            $('#historyId').addClass('current-page').siblings()
                        .removeClass('current-page');
            var parent = $('#historyId').parents('li');
            parent.addClass('active').siblings().removeClass('active');
            $('#historyId').parents().show();

	    });
        function processMessage(){
            /*<![CDATA[*/
                var msgSuccess = [[${msgSuccess}]];
                var msgError = [[${msgError}]];
            /*]]>*/
            if(msgSuccess){
                new PNotify({
                    title: ' Success',
                    text: msgSuccess,
                    type: 'success',
                    styling: 'bootstrap3'
                });
            }
            if(msgError){
                new PNotify({
                    title: ' Error',
                    text: msgError,
                    type: 'error',
                    styling: 'bootstrap3'
                });
            }
        }

        function renderPagination(currentPage, totalPages) {
            var paginationElement = $('.pagination');
            paginationElement.empty();

            function addPage(page) {
                const pageLi = $('<li>');
                const pageBtn = $('<a>').attr('href', '#').text(page);
                if(page === currentPage) {
                    pageLi.addClass('active');
                } else {
                    pageBtn.on('click', function (e) {
                        e.preventDefault();
                        gotoPage(page);
                    });
                }
                pageLi.append(pageBtn);
                paginationElement.append(pageLi);
            }

            addPage(1);

            if (currentPage > 3) paginationElement.append('<li><span>...</span></li>');

            for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
                addPage(i);
            }

            if (currentPage < totalPages - 3) paginationElement.append('<li><span>...</span></li>');

            if (totalPages > 1) addPage(totalPages);
        }

    </script>
</div>
</body>
</html>